<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, initial-scale=1">
    <title>Go Kart Go! | Man Games</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FFCE54;
            --accent: #48CFAD;
            --bg: #E0F7FA;
            --road: #656D78;
            --grass: #A0D468;
            --text: #2D3436;
            --danger: #ED5565;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            /* Prevent zoom/scroll on mobile */
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-image: radial-gradient(#FFCE54 1px, transparent 1px);
            background-size: 30px 30px;
            overflow: hidden;
        }

        #gameWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
        }

        #gameWrapper:fullscreen {
            background: var(--bg);
            justify-content: flex-start;
            padding-top: 20px;
            overflow-y: auto;
        }

        .game-container {
            position: relative;
            background: #fff;
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 5px solid #fff;
            outline: none;
            /* Remove focus outline */
        }

        #gameWrapper:fullscreen .game-container {
            box-shadow: none;
            border: none;
            background: transparent;
            padding: 0;
            margin-top: 10px;
        }

        canvas {
            background: var(--grass);
            border-radius: 10px;
            display: block;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
        }

        #gameWrapper:fullscreen canvas {
            height: 60vh;
            /* Reduced height to make room for controls */
            width: auto;
            max-width: 100%;
        }

        .ui-panel {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            margin-bottom: 0.5rem;
            padding: 0 5px;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            position: relative;
            z-index: 100;
        }

        .score-box {
            background: #fff;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .jump-bar-container {
            width: 100px;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-left: 5px;
        }

        .jump-bar-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.1s;
        }

        .btn {
            background: var(--primary);
            color: var(--text);
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-family: inherit;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #F6BB42;
            transition: all 0.1s;
        }

        .btn:focus {
            outline: 3px solid var(--accent);
            transform: scale(1.05);
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #F6BB42;
        }

        .btn-secondary {
            background: #AAB2BD;
            box-shadow: 0 4px 0 #656D78;
            color: white;
        }

        .btn-secondary:active {
            box-shadow: 0 0 0 #656D78;
        }

        .btn-home {
            background: var(--accent);
            box-shadow: 0 4px 0 #37BC9B;
            margin-top: 15px;
            text-decoration: none;
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .btn-home:focus {
            outline: 3px solid var(--primary);
            transform: scale(1.05);
        }

        .btn-home:active {
            box-shadow: 0 0 0 #37BC9B;
            transform: translateY(4px);
        }

        .btn-fullscreen {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-fullscreen:focus {
            outline: 2px solid var(--accent);
        }

        /* Mobile Controls */
        #mobileControls {
            display: none;
            /* Hidden by default */
            position: relative;
            margin-top: 20px;
            width: 200px;
            height: 200px;
            z-index: 100;
        }

        body.mode-mobile #mobileControls,
        #gameWrapper:fullscreen #mobileControls {
            display: block;
        }

        /* Hide on TV even if fullscreen */
        body.mode-tv #mobileControls {
            display: none !important;
        }

        .dpad-btn {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            border: 2px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            user-select: none;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
        }

        .dpad-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1);
            background: #fff;
        }

        #btnUp {
            top: 0;
            left: 70px;
        }

        #btnDown {
            bottom: 0;
            left: 70px;
        }

        #btnLeft {
            top: 70px;
            left: 0;
        }

        #btnRight {
            top: 70px;
            right: 0;
        }

        #btnJump {
            top: 70px;
            left: 70px;
            background: var(--accent);
            color: white;
            border-color: #37BC9B;
            box-shadow: 0 4px 0 #37BC9B;
        }

        #btnJump:active {
            box-shadow: 0 2px 0 #37BC9B;
        }

        /* Overlays */
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            min-width: 320px;
            z-index: 10;
        }

        #startScreen {
            display: block;
        }

        #gameOverModal {
            display: none;
        }

        h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 0 #F6BB42;
        }

        h2 {
            color: var(--text);
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .final-score {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .name-input {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #ddd;
            font-family: inherit;
            font-size: 1rem;
            width: 80%;
            display: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .controls-hint {
            margin-top: 1rem;
            color: #888;
            font-size: 0.9rem;
            text-align: center;
        }

        /* TV Mode */
        body.mode-tv {
            cursor: none;
        }
    </style>
</head>

<body>

    <div id="gameWrapper">
        <div class="ui-panel">
            <div class="score-box">🏁 <span id="score">0</span>m</div>
            <div class="score-box">❤️ <span id="health">3</span></div>
            <div class="score-box">⚙️ <span id="gear">1</span></div>
            <div class="score-box">⚡ <span id="speed">0</span> km/h</div>
            <div class="score-box">
                🚀
                <div class="jump-bar-container">
                    <div id="jumpBar" class="jump-bar-fill"></div>
                </div>
            </div>
            <button class="btn-fullscreen" onclick="toggleFullScreen()">⛶</button>
        </div>

        <div class="game-container" id="gameContainer" tabindex="0">
            <canvas id="gameCanvas" width="400" height="600"></canvas>

            <!-- Start Screen -->
            <div id="startScreen" class="overlay">
                <h1>GO KART GO!</h1>
                <h2>Start Your Engines!</h2>
                <button class="btn" onclick="startGame()">RACE!</button>
                <p class="controls-hint">⬅️➡️ Steer • ⬆️⬇️ Gears • SPACE Jump</p>
            </div>

            <!-- Game Over Modal -->
            <div id="gameOverModal" class="overlay">
                <h1 id="gameOverTitle" style="color: #ED5565;">GAME OVER</h1>
                <p class="final-score">Distance: <span id="finalScore">0</span>m</p>
                <input type="text" id="playerNameInput" class="name-input" placeholder="Enter your name" maxlength="10">
                <div class="button-group">
                    <button class="btn" onclick="handleGameOverAction()">RACE AGAIN</button>
                    <button class="btn btn-secondary" onclick="showStartScreen()">MENU</button>
                </div>
            </div>
        </div>

        <!-- Mobile D-Pad -->
        <div id="mobileControls">
            <div id="btnUp" class="dpad-btn">⬆️</div>
            <div id="btnLeft" class="dpad-btn">⬅️</div>
            <div id="btnJump" class="dpad-btn">🚀</div>
            <div id="btnRight" class="dpad-btn">➡️</div>
            <div id="btnDown" class="dpad-btn">⬇️</div>
        </div>
    </div>

    <a href="index.html" class="btn btn-home">🏠 BACK TO HOME</a>

    <script>
        // Check URL params for mode
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        function isTouchDevice() {
            return (('ontouchstart' in window) ||
                (navigator.maxTouchPoints > 0) ||
                (navigator.msMaxTouchPoints > 0));
        }

        if (mode) {
            document.body.classList.add('mode-' + mode);
        } else if (isTouchDevice()) {
            document.body.classList.add('mode-mobile');
        }

        // Sound Manager
        const SoundManager = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),

            playTone(freq, type, duration, vol = 0.1) {
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);

                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            playJump() {
                this.playTone(400, 'sine', 0.1, 0.1);
                setTimeout(() => this.playTone(600, 'sine', 0.2, 0.1), 50);
            },

            playCrash() {
                this.playTone(100, 'sawtooth', 0.5, 0.3);
                setTimeout(() => this.playTone(50, 'sawtooth', 0.5, 0.3), 100);
            },

            playCoin() {
                this.playTone(1200, 'sine', 0.1, 0.1);
                setTimeout(() => this.playTone(1800, 'sine', 0.2, 0.1), 50);
            },

            playShift() {
                this.playTone(200, 'square', 0.1, 0.05);
            }
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const speedEl = document.getElementById('speed');
        const gearEl = document.getElementById('gear');
        const healthEl = document.getElementById('health');
        const jumpBar = document.getElementById('jumpBar');
        const startScreen = document.getElementById('startScreen');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreEl = document.getElementById('finalScore');
        const nameInput = document.getElementById('playerNameInput');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const gameContainer = document.getElementById('gameContainer');

        // Game State
        let score = 0;
        let highScore = 0;
        let isGameOver = false;

        // Road
        const roadWidth = 320; // 4 lanes * 80px
        const roadX = (canvas.width - roadWidth) / 2;
        const laneCount = 4;
        const laneWidth = roadWidth / laneCount;
        let roadOffset = 0;

        // Physics & Gears
        let speed = 0; // Game units
        let displaySpeed = 0; // 0-120 km/h
        let gear = 1;
        const maxGear = 5;
        // Max speed for each gear (in game units)
        // Max game speed 24 -> 120 km/h
        const gearMaxSpeeds = [5, 10, 15, 20, 24];
        const gearMinSpeeds = [0, 4, 9, 14, 19]; // Min speed to accelerate effectively

        // Player
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 120,
            width: 40,
            height: 70,
            color: '#FFCE54',
            lane: 1, // 0, 1, 2, 3
            targetX: canvas.width / 2,
            health: 3,
            isJumping: false,
            jumpHeight: 0,
            jumpCharge: 100,
            canJump: true
        };

        // Objects
        let obstacles = []; // Traffic
        let coins = [];
        let particles = [];

        // Traffic Types
        const VehicleTypes = [
            { type: 'car', color: '#ED5565', width: 40, height: 70, speed: 10 },
            { type: 'truck', color: '#AAB2BD', width: 50, height: 100, speed: 8 },
            { type: 'racer', color: '#967ADC', width: 38, height: 70, speed: 18 },
            { type: 'bike', color: '#48CFAD', width: 20, height: 50, speed: 12 }
        ];

        // Input
        let keys = {
            left: false,
            right: false,
            up: false,
            down: false,
            space: false
        };

        function startGame() {
            startScreen.style.display = 'none';
            gameOverModal.style.display = 'none';
            if (SoundManager.ctx.state === 'suspended') SoundManager.ctx.resume();
            resetGame();
            gameContainer.focus();
            requestAnimationFrame(update);
        }

        function resetGame() {
            score = 0;
            speed = 0;
            gear = 1;
            player.lane = 1;
            player.x = roadX + laneWidth * 1.5;
            player.targetX = player.x;
            player.health = 3;
            player.jumpCharge = 100;
            player.isJumping = false;
            player.jumpHeight = 0;

            obstacles = [];
            coins = [];
            particles = [];

            isGameOver = false;
            updateUI();
        }

        function showStartScreen() {
            gameOverModal.style.display = 'none';
            startScreen.style.display = 'block';
            isGameOver = true;

            // Focus start button
            setTimeout(() => {
                const btn = startScreen.querySelector('button');
                if (btn) btn.focus();
            }, 100);
        }

        function handleGameOverAction() {
            if (nameInput.style.display !== 'none') {
                // Save score logic here if needed
            }
            startGame();
        }

        function update() {
            if (isGameOver) return;

            // --- Physics & Gears ---
            const targetSpeed = gearMaxSpeeds[gear - 1];
            const minEffectiveSpeed = gearMinSpeeds[gear - 1];

            // Acceleration Factor
            // If speed is below minEffectiveSpeed, acceleration is very slow (lugging)
            let accFactor = 0.1; // Base acceleration
            if (speed < minEffectiveSpeed) {
                accFactor = 0.02; // Penalty for wrong gear
            }

            // Accelerate towards target speed
            if (speed < targetSpeed) {
                speed += accFactor;
            } else if (speed > targetSpeed) {
                speed -= 0.1; // Engine braking
            }

            // Display Speed (0 - 120)
            // Max game speed 24 -> 120 km/h
            displaySpeed = Math.floor((speed / 24) * 120);

            // Move Road
            roadOffset += speed;
            if (roadOffset > 80) roadOffset = 0; // 80 is dash spacing

            // Score
            score += speed * 0.1;

            // --- Player Movement ---
            player.targetX = roadX + (player.lane * laneWidth) + (laneWidth / 2);
            player.x += (player.targetX - player.x) * 0.2;

            // Jump Logic
            if (player.isJumping) {
                player.jumpHeight += player.jumpVelocity;
                player.jumpVelocity -= 1; // Gravity
                if (player.jumpHeight <= 0) {
                    player.jumpHeight = 0;
                    player.isJumping = false;
                }
            } else {
                // Recharge Jump
                if (player.jumpCharge < 100) player.jumpCharge += 0.5;
            }

            // --- Spawning ---
            if (Math.random() < 0.03) spawnTraffic();
            if (Math.random() < 0.01) spawnCoin();

            updateObstacles();
            updateCoins();
            updateParticles();
            updateUI();
            draw();

            requestAnimationFrame(update);
        }

        function spawnTraffic() {
            const lane = Math.floor(Math.random() * 4);

            // Check if lane is occupied
            const isLaneOccupied = obstacles.some(obs => obs.lane === lane);
            if (isLaneOccupied) return;

            const type = VehicleTypes[Math.floor(Math.random() * VehicleTypes.length)];

            // Lane 0, 1: Forward (Left)
            // Lane 2, 3: Oncoming (Right)

            let x = roadX + (lane * laneWidth) + (laneWidth / 2);
            let y = -150;
            let isOncoming = false;

            if (lane >= 2) {
                // Oncoming
                isOncoming = true;
            }

            obstacles.push({
                ...type,
                x: x,
                y: y,
                lane: lane,
                isOncoming: isOncoming
            });
        }

        function spawnCoin() {
            const lane = Math.floor(Math.random() * 4);
            const x = roadX + (lane * laneWidth) + (laneWidth / 2);
            coins.push({
                x: x,
                y: -100,
                radius: 10,
                color: '#FFCE54'
            });
        }

        function updateObstacles() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];

                // Movement Logic
                if (obs.isOncoming) {
                    // Moving towards player
                    obs.y += speed + (obs.speed * 0.5);
                } else {
                    // Moving same direction
                    // Relative speed: PlayerSpeed - TrafficSpeed
                    // Since 'speed' moves the world down, we add (speed - trafficSpeed)
                    obs.y += speed - (obs.speed * 0.5);
                }

                // Collision
                // Ignore collision if jumping high enough
                if (!player.isJumping || player.jumpHeight < 20) {
                    if (Math.abs(obs.x - player.x) < (obs.width / 2 + player.width / 2 - 10) &&
                        Math.abs(obs.y - player.y) < (obs.height / 2 + player.height / 2 - 10)) {
                        handleCrash();
                        obstacles.splice(i, 1);
                        continue;
                    }
                }

                // Remove if off screen
                if (obs.y > canvas.height + 200 || obs.y < -300) {
                    obstacles.splice(i, 1);
                }
            }
        }

        function handleCrash() {
            SoundManager.playCrash();
            createParticles(player.x, player.y, '#ED5565', 15);
            player.health--;
            speed = 0;
            gear = 1;

            if (player.health <= 0) {
                isGameOver = true;
                finalScoreEl.textContent = Math.floor(score);
                gameOverModal.style.display = 'block';

                // Focus restart button
                setTimeout(() => {
                    const btn = gameOverModal.querySelector('button');
                    if (btn) btn.focus();
                }, 100);
            }
        }

        function updateCoins() {
            for (let i = coins.length - 1; i >= 0; i--) {
                let coin = coins[i];
                coin.y += speed;

                if (Math.abs(coin.x - player.x) < 30 && Math.abs(coin.y - player.y) < 50) {
                    // Can collect coins while jumping? Sure.
                    score += 50;
                    SoundManager.playCoin();
                    createParticles(coin.x, coin.y, '#FFCE54', 5);
                    coins.splice(i, 1);
                } else if (coin.y > canvas.height) {
                    coins.splice(i, 1);
                }
            }
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1.0, color: color
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy;
                p.life -= 0.05;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function updateUI() {
            scoreEl.textContent = Math.floor(score);
            speedEl.textContent = displaySpeed;
            gearEl.textContent = gear;
            healthEl.textContent = "❤️".repeat(player.health);
            jumpBar.style.width = player.jumpCharge + "%";

            // Color code speed
            if (displaySpeed > 100) speedEl.style.color = '#ED5565';
            else speedEl.style.color = '#2D3436';
        }

        function draw() {
            // Grass
            ctx.fillStyle = '#A0D468';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Road
            ctx.fillStyle = '#656D78';
            ctx.fillRect(roadX, 0, roadWidth, canvas.height);

            // Lane Markers
            ctx.lineWidth = 4;
            ctx.setLineDash([30, 50]);
            ctx.lineDashOffset = -roadOffset;

            // Lane 1 divider (Single)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.beginPath();
            ctx.moveTo(roadX + laneWidth, 0);
            ctx.lineTo(roadX + laneWidth, canvas.height);
            ctx.stroke();

            // Center divider (Double Yellow/White) - Separating Forward/Backward
            ctx.strokeStyle = '#FFCE54';
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(roadX + laneWidth * 2 - 4, 0);
            ctx.lineTo(roadX + laneWidth * 2 - 4, canvas.height);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(roadX + laneWidth * 2 + 4, 0);
            ctx.lineTo(roadX + laneWidth * 2 + 4, canvas.height);
            ctx.stroke();

            // Lane 3 divider (Single)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(roadX + laneWidth * 3, 0);
            ctx.lineTo(roadX + laneWidth * 3, canvas.height);
            ctx.stroke();

            ctx.setLineDash([]); // Reset

            // Road Borders
            ctx.fillStyle = '#FFF';
            ctx.fillRect(roadX - 10, 0, 10, canvas.height);
            ctx.fillRect(roadX + roadWidth, 0, 10, canvas.height);


            // Red stripes on border
            ctx.fillStyle = '#ED5565';
            // ... (Stripes logic could be here, but simple white is fine for now)

            // Coins
            coins.forEach(coin => {
                ctx.fillStyle = coin.color;
                ctx.beginPath();
                ctx.arc(coin.x, coin.y, coin.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#F6BB42';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Obstacles
            obstacles.forEach(obs => {
                ctx.fillStyle = obs.color;
                ctx.fillRect(obs.x - obs.width / 2, obs.y - obs.height / 2, obs.width, obs.height);
                // Simple detail
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(obs.x - obs.width / 2, obs.y - obs.height / 2 + 5, obs.width, 10); // Windshield
            });

            // Player
            ctx.save();
            // Apply Jump Scale/Offset
            const scale = 1 + (player.jumpHeight / 100);
            ctx.translate(player.x, player.y - player.jumpHeight);
            ctx.scale(scale, scale);

            // Kart Body
            ctx.fillStyle = player.color;
            ctx.fillRect(-15, -25, 30, 50);

            // Wheels
            ctx.fillStyle = '#333';
            ctx.fillRect(-20, -20, 5, 12); // FL
            ctx.fillRect(15, -20, 5, 12);  // FR
            ctx.fillRect(-20, 10, 5, 12);  // RL
            ctx.fillRect(15, 10, 5, 12);   // RR

            // Driver Head
            ctx.fillStyle = '#E6E9ED'; // Helmet
            ctx.beginPath();
            ctx.arc(0, 0, 10, 0, Math.PI * 2);
            ctx.fill();

            // Spoiler
            ctx.fillStyle = '#D35400';
            ctx.fillRect(-18, 20, 36, 5);

            ctx.restore();

            // Particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1.0;
        }

        // --- Controls ---

        function shiftUp() {
            if (gear < maxGear) {
                gear++;
                SoundManager.playShift();
                updateUI();
            }
        }

        function shiftDown() {
            if (gear > 1) {
                gear--;
                SoundManager.playShift();
                updateUI();
            }
        }

        function moveLeft() {
            if (player.lane > 0) player.lane--;
        }

        function moveRight() {
            if (player.lane < laneCount - 1) player.lane++;
        }

        function jump() {
            if (player.jumpCharge >= 100 && !player.isJumping) {
                player.isJumping = true;
                player.jumpVelocity = 12;
                player.jumpCharge = 0;
                SoundManager.playJump();
            }
        }

        // Keyboard Input
        window.addEventListener('keydown', e => {
            const key = e.key;
            const keyCode = e.keyCode;

            // TV Keys
            const TV_LEFT = 37;
            const TV_UP = 38;
            const TV_RIGHT = 39;
            const TV_DOWN = 40;
            const TV_ENTER = 13;

            // Alternate TV Keys
            const ALT_LEFT = 21;
            const ALT_RIGHT = 22;
            const ALT_UP = 19;
            const ALT_DOWN = 20;
            const ALT_ENTER = 23;
            const ALT_BACK = 4;
            const TIZEN_BACK = 10009;

            let handled = false;

            // Handle Back Button
            if (key === 'Backspace' || key === 'Escape' || keyCode === 8 || keyCode === 27 || keyCode === 461 || keyCode === TIZEN_BACK || keyCode === ALT_BACK) {
                window.location.href = 'index.html';
                handled = true;
            }

            // Steering
            if (['ArrowLeft', 'a', 'A', '4'].includes(key) || keyCode === TV_LEFT || keyCode === ALT_LEFT) {
                moveLeft();
                handled = true;
            }
            if (['ArrowRight', 'd', 'D', '6'].includes(key) || keyCode === TV_RIGHT || keyCode === ALT_RIGHT) {
                moveRight();
                handled = true;
            }

            // Gears
            if (['ArrowUp', 'w', 'W', '2'].includes(key) || keyCode === TV_UP || keyCode === ALT_UP) {
                shiftUp();
                handled = true;
            }
            if (['ArrowDown', 's', 'S', '8'].includes(key) || keyCode === TV_DOWN || keyCode === ALT_DOWN) {
                shiftDown();
                handled = true;
            }

            // Jump / Action
            if ([' ', 'Enter', '5'].includes(key) || keyCode === TV_ENTER || keyCode === ALT_ENTER) {
                if (startScreen.style.display !== 'none') {
                    const focusedBtn = document.activeElement.tagName === 'BUTTON' ? document.activeElement : null;
                    if (focusedBtn) {
                        focusedBtn.click();
                    } else {
                        startGame();
                    }
                } else if (gameOverModal.style.display !== 'none') {
                    const focusedBtn = document.activeElement.tagName === 'BUTTON' ? document.activeElement : null;
                    if (focusedBtn) {
                        focusedBtn.click();
                    } else {
                        handleGameOverAction();
                    }
                } else {
                    jump();
                }
                handled = true;
            }

            // Fullscreen
            if (key === '0') {
                toggleFullScreen();
                handled = true;
            }

            if (handled) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        // Mouse Input (PC Jump)
        window.addEventListener('mousedown', e => {
            // Only if not clicking a button
            if (e.target.tagName !== 'BUTTON' && !e.target.classList.contains('dpad-btn')) {
                jump();
            }
        });

        // Touch Input (Mobile D-Pad)
        const btnUp = document.getElementById('btnUp');
        const btnDown = document.getElementById('btnDown');
        const btnLeft = document.getElementById('btnLeft');
        const btnRight = document.getElementById('btnRight');
        const btnJump = document.getElementById('btnJump');

        // Prevent default touch actions (scrolling/zooming) on buttons
        const dpadButtons = [btnUp, btnDown, btnLeft, btnRight, btnJump];
        dpadButtons.forEach(btn => {
            if (!btn) return;
            const handleInput = (e) => {
                e.preventDefault(); // Prevent ghost clicks
                if (btn === btnUp) shiftUp();
                if (btn === btnDown) shiftDown();
                if (btn === btnLeft) moveLeft();
                if (btn === btnRight) moveRight();
                if (btn === btnJump) jump();
            };
            btn.addEventListener('touchstart', handleInput, { passive: false });
            btn.addEventListener('mousedown', handleInput);
        });

        // Focus game container on load for TV
        window.onload = () => {
            if (startScreen.style.display !== 'none') {
                const btn = startScreen.querySelector('button');
                if (btn) btn.focus();
            } else {
                gameContainer.focus();
            }
        };

        // Keep focus
        gameContainer.addEventListener('blur', () => {
            if (!isGameOver && startScreen.style.display === 'none') {
                setTimeout(() => gameContainer.focus(), 50);
            }
        });

        function toggleFullScreen() {
            const elem = document.getElementById("gameWrapper");
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) elem.msExitFullscreen();
            }
        }

        // Start screen focus
        showStartScreen();

    </script>
    <script src="global.js"></script>
</body>

</html>