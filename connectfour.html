<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Four | Man Games</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #2c3e50;
            --board-color: #2980b9;
            --slot-empty: #34495e;
            --p1-color: #e74c3c;
            --p2-color: #f1c40f;
            --text-color: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            /* Prevent scrolling */
        }

        h1 {
            font-family: 'Fredoka', sans-serif;
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 0 #000;
        }

        .status-bar {
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 30px;
            border-radius: 50px;
        }

        .turn-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .board {
            background: var(--board-color);
            padding: 20px;
            border-radius: 20px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            outline: none;
            /* Remove focus outline */
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 10px;
            cursor: pointer;
            position: relative;
        }

        .column:hover .slot.empty {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Highlight selected column for keyboard/remote */
        .column.selected::before {
            content: '▼';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 20px;
            animation: bounce 0.5s infinite alternate;
        }

        @keyframes bounce {
            from {
                top: -30px;
            }

            to {
                top: -35px;
            }
        }

        .slot {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--slot-empty);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.3);
        }

        .piece {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transform: translateY(-500px);
            animation: drop 0.5s forwards cubic-bezier(0.5, 0, 0.5, 1);
        }

        @keyframes drop {
            to {
                transform: translateY(0);
            }
        }

        .piece.red {
            background: var(--p1-color);
        }

        .piece.yellow {
            background: var(--p2-color);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            padding: 3rem;
            border-radius: 30px;
            text-align: center;
            color: #2c3e50;
            max-width: 90%;
            width: 400px;
            animation: popIn 0.3s;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        button {
            padding: 1rem 2rem;
            border-radius: 50px;
            border: none;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            cursor: pointer;
            background: var(--board-color);
            color: white;
            font-weight: bold;
            margin-top: 20px;
            box-shadow: 0 4px 0 #1a5276;
            transition: all 0.1s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #1a5276;
        }

        .difficulty-btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            margin: 0 5px;
            background: #34495e;
            color: #fff;
            border: 1px solid #5d6d7e;
            box-shadow: 0 4px 0 #2c3e50;
        }

        .difficulty-btn:hover {
            background: #2c3e50;
            box-shadow: 0 6px 0 #1a252f;
        }

        .difficulty-btn.selected {
            background: #f1c40f;
            color: #2c3e50;
            box-shadow: 0 4px 0 #d4ac0d;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 30px;
        }

        .controls-hint {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        .key-badge {
            display: inline-block;
            background: #34495e;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin: 0 2px;
        }

        /* TV Mode */
        body.mode-tv {
            cursor: none;
        }

        body.mode-tv button:focus {
            outline: 5px solid var(--p2-color);
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <a href="index.html" class="back-btn">← Back</a>

    <h1>Connect Four</h1>

    <div class="status-bar">
        <span class="turn-indicator" id="turnIndicator" style="background: var(--p1-color);"></span>
        <span id="statusText">Player 1's Turn</span>
    </div>

    <div class="board" id="board" tabindex="0">
        <!-- Columns and Slots generated by JS -->
    </div>

    <div class="controls-hint">
        <p>Use <span class="key-badge">4</span> (Left) and <span class="key-badge">6</span> (Right) to Select</p>
        <p>Press <span class="key-badge">5</span> to Drop</p>
    </div>

    <!-- Start Modal -->
    <div class="modal-overlay" id="startModal">
        <div class="modal">
            <h2>Connect Four</h2>
            <p style="margin-bottom: 15px;">Get 4 in a row to win!</p>
            <p style="margin-bottom: 10px; font-size: 0.9rem; color: #7f8c8d;">Select Difficulty:</p>
            <div style="margin-bottom: 20px;">
                <button class="difficulty-btn selected" onclick="selectDifficulty('easy')">Easy</button>
                <button class="difficulty-btn" onclick="selectDifficulty('medium')">Medium</button>
                <button class="difficulty-btn" onclick="selectDifficulty('hard')">Hard</button>
            </div>
            <button onclick="startGame()">Start Game</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal-overlay" id="gameOverModal" style="display: none;">
        <div class="modal">
            <h2 id="winnerText">Player 1 Wins!</h2>
            <button onclick="startGame()">Play Again</button>
        </div>
    </div>

    <script>
        const boardEl = document.getElementById('board');
        const statusText = document.getElementById('statusText');
        const turnIndicator = document.getElementById('turnIndicator');
        const startModal = document.getElementById('startModal');
        const gameOverModal = document.getElementById('gameOverModal');
        const winnerText = document.getElementById('winnerText');

        const ROWS = 6;
        const COLS = 7;
        let board = []; // 2D array [col][row]
        let currentPlayer = 1; // 1 = Red (Player), 2 = Yellow (CPU)
        let gameActive = false;
        let selectedCol = 3; // Center
        let currentDifficulty = 'easy';
        let isCpuThinking = false;

        const difficulties = ['easy', 'medium', 'hard'];

        function selectDifficulty(diff) {
            currentDifficulty = diff;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.toLowerCase() === diff) btn.classList.add('selected');
            });
        }

        function cycleDifficulty(direction) {
            let currentIndex = difficulties.indexOf(currentDifficulty);
            currentIndex += direction;

            if (currentIndex < 0) currentIndex = difficulties.length - 1;
            if (currentIndex >= difficulties.length) currentIndex = 0;

            selectDifficulty(difficulties[currentIndex]);
        }

        function createBoard() {
            boardEl.innerHTML = '';
            board = [];

            for (let c = 0; c < COLS; c++) {
                const colDiv = document.createElement('div');
                colDiv.classList.add('column');
                colDiv.dataset.col = c;
                colDiv.addEventListener('click', () => handleColumnClick(c));

                let colArray = [];
                for (let r = 0; r < ROWS; r++) {
                    const slot = document.createElement('div');
                    slot.classList.add('slot', 'empty');
                    colDiv.appendChild(slot);
                    colArray.push(0); // 0 = empty
                }
                board.push(colArray);
                boardEl.appendChild(colDiv);
            }
            updateCursor();
        }

        function startGame() {
            startModal.style.display = 'none';
            gameOverModal.style.display = 'none';
            currentPlayer = 1;
            gameActive = true;
            isCpuThinking = false;
            updateStatus();
            createBoard();
            // Focus board for game
            boardEl.focus();
        }

        function updateStatus() {
            if (currentPlayer === 1) {
                statusText.textContent = "Your Turn";
                turnIndicator.style.background = "var(--p1-color)";
            } else {
                statusText.textContent = "CPU Thinking...";
                turnIndicator.style.background = "var(--p2-color)";
            }
        }

        function handleColumnClick(colIndex) {
            if (!gameActive || currentPlayer !== 1 || isCpuThinking) return;
            selectedCol = colIndex;
            updateCursor();
            dropPiece(colIndex);
        }

        function dropPiece(colIndex) {
            const col = board[colIndex];
            // Find lowest empty slot
            let rowIndex = -1;
            for (let r = ROWS - 1; r >= 0; r--) {
                if (col[r] === 0) {
                    rowIndex = r;
                    break;
                }
            }

            if (rowIndex === -1) return; // Column full

            // Update Logic
            col[rowIndex] = currentPlayer;

            // Update Visuals
            const colDiv = boardEl.children[colIndex];
            const slot = colDiv.children[rowIndex];
            slot.classList.remove('empty');

            const piece = document.createElement('div');
            piece.classList.add('piece');
            piece.classList.add(currentPlayer === 1 ? 'red' : 'yellow');
            slot.appendChild(piece);

            if (checkWin(colIndex, rowIndex)) {
                endGame(currentPlayer);
            } else if (checkDraw()) {
                endGame(0);
            } else {
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                updateStatus();
                if (currentPlayer === 2) {
                    isCpuThinking = true;
                    setTimeout(cpuMove, 500);
                }
            }
        }

        function cpuMove() {
            if (!gameActive) return;

            let col = -1;

            if (currentDifficulty === 'easy') {
                col = getRandomMove();
            } else if (currentDifficulty === 'medium') {
                // Try to win or block, else random
                col = findBestMove(2); // Win
                if (col === -1) col = findBestMove(1); // Block
                if (col === -1) col = getRandomMove();
            } else { // Hard
                // Minimax-ish (simplified for responsiveness)
                // 1. Win
                col = findBestMove(2);
                // 2. Block
                if (col === -1) col = findBestMove(1);
                // 3. Strategic Center
                if (col === -1 && isValidMove(3)) col = 3;
                // 4. Random valid
                if (col === -1) col = getRandomMove();
            }

            // Fallback if column full (shouldn't happen with getRandomMove logic)
            if (col === -1 || !isValidMove(col)) {
                col = getRandomMove();
            }

            isCpuThinking = false;
            dropPiece(col);
        }

        function isValidMove(c) {
            return board[c][0] === 0;
        }

        function getRandomMove() {
            let validCols = [];
            for (let c = 0; c < COLS; c++) {
                if (isValidMove(c)) validCols.push(c);
            }
            if (validCols.length === 0) return -1;
            return validCols[Math.floor(Math.random() * validCols.length)];
        }

        function findBestMove(player) {
            // Check for immediate win/block
            for (let c = 0; c < COLS; c++) {
                if (!isValidMove(c)) continue;

                // Simulate drop
                let r = -1;
                for (let i = ROWS - 1; i >= 0; i--) {
                    if (board[c][i] === 0) {
                        r = i;
                        break;
                    }
                }

                board[c][r] = player;
                let win = checkWin(c, r);
                board[c][r] = 0; // Undo

                if (win) return c;
            }
            return -1;
        }

        function checkWin(c, r) {
            const player = board[c][r];

            // Directions: Horizontal, Vertical, Diagonal /, Diagonal \
            return checkDirection(c, r, 1, 0, player) || // Horizontal
                checkDirection(c, r, 0, 1, player) || // Vertical
                checkDirection(c, r, 1, 1, player) || // Diag \
                checkDirection(c, r, 1, -1, player);  // Diag /
        }

        function checkDirection(c, r, dc, dr, player) {
            let count = 1;

            // Check forward
            for (let i = 1; i < 4; i++) {
                const nc = c + dc * i;
                const nr = r + dr * i;
                if (nc < 0 || nc >= COLS || nr < 0 || nr >= ROWS) break;
                if (board[nc][nr] === player) count++;
                else break;
            }

            // Check backward
            for (let i = 1; i < 4; i++) {
                const nc = c - dc * i;
                const nr = r - dr * i;
                if (nc < 0 || nc >= COLS || nr < 0 || nr >= ROWS) break;
                if (board[nc][nr] === player) count++;
                else break;
            }

            return count >= 4;
        }

        function checkDraw() {
            return board.every(col => col[0] !== 0);
        }

        function endGame(winner) {
            gameActive = false;
            if (winner === 0) {
                winnerText.textContent = "It's a Draw!";
                winnerText.style.color = "#fff";
            } else {
                winnerText.textContent = winner === 1 ? "You Win!" : "CPU Wins!";
                winnerText.style.color = winner === 1 ? "var(--p1-color)" : "var(--p2-color)";
            }
            setTimeout(() => {
                gameOverModal.style.display = 'flex';
                gameOverModal.querySelector('button').focus();
            }, 1000);
        }

        // Cursor Logic
        function updateCursor() {
            Array.from(boardEl.children).forEach((col, idx) => {
                if (idx === selectedCol) col.classList.add('selected');
                else col.classList.remove('selected');
            });
        }

        // Input Handling
        document.addEventListener('keydown', (e) => {
            const key = e.key;
            const keyCode = e.keyCode;

            // TV Keys
            const TV_LEFT = 37;
            const TV_RIGHT = 39;
            const TV_ENTER = 13;

            // Alternate TV Keys
            const ALT_LEFT = 21;
            const ALT_RIGHT = 22;
            const ALT_ENTER = 23;
            const ALT_BACK = 4;
            const TIZEN_BACK = 10009;

            let handled = false;

            // Handle Back Button
            if (key === 'Backspace' || key === 'Escape' || keyCode === 8 || keyCode === 27 || keyCode === 461 || keyCode === TIZEN_BACK || keyCode === ALT_BACK) {
                window.location.href = 'index.html';
                handled = true;
            }

            if (startModal.style.display !== 'none') {
                if (key === '4' || key === 'ArrowLeft' || keyCode === TV_LEFT || keyCode === ALT_LEFT) {
                    cycleDifficulty(-1);
                    handled = true;
                }
                if (key === '6' || key === 'ArrowRight' || keyCode === TV_RIGHT || keyCode === ALT_RIGHT) {
                    cycleDifficulty(1);
                    handled = true;
                }
                if (['Enter', ' ', '5'].includes(key) || keyCode === TV_ENTER || keyCode === ALT_ENTER) {
                    startGame();
                    handled = true;
                }
            } else if (gameOverModal.style.display !== 'none') {
                if (['Enter', ' ', '5'].includes(key) || keyCode === TV_ENTER || keyCode === ALT_ENTER) {
                    startGame();
                    handled = true;
                }
            } else {
                // Game Controls
                if (key === 'ArrowLeft' || key === '4' || keyCode === TV_LEFT || keyCode === ALT_LEFT) {
                    if (selectedCol > 0) {
                        selectedCol--;
                        updateCursor();
                    }
                    handled = true;
                } else if (key === 'ArrowRight' || key === '6' || keyCode === TV_RIGHT || keyCode === ALT_RIGHT) {
                    if (selectedCol < COLS - 1) {
                        selectedCol++;
                        updateCursor();
                    }
                    handled = true;
                } else if (key === 'Enter' || key === ' ' || key === '5' || keyCode === TV_ENTER || keyCode === ALT_ENTER) {
                    handleColumnClick(selectedCol);
                    handled = true;
                } else if (key === '0') {
                    window.location.href = 'index.html';
                    handled = true;
                }
            }

            if (handled) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        // Check mode
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            if (mode) {
                document.body.classList.add(`mode-${mode}`);
            }
        });

        // Focus board on load for TV
        window.onload = () => {
            boardEl.focus();
        };

        // Keep focus on board
        boardEl.addEventListener("blur", () => {
            if (startModal.style.display === 'none' && gameOverModal.style.display === 'none') {
                setTimeout(() => boardEl.focus(), 50);
            }
        });

        // Init
        createBoard();
        setTimeout(() => startModal.querySelector('button').focus(), 100);
    </script>
    <script src="global.js"></script>
</body>

</html>