<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, initial-scale=1">
    <title>Flappy Bird | Man Games</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #70c5ce;
            --text-color: #ffffff;
            --accent: #f1c40f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #2c3e50;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }

        h1 {
            font-family: 'Fredoka', sans-serif;
            position: absolute;
            top: 20px;
            font-size: 3rem;
            color: white;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
        }

        canvas {
            background-color: var(--bg-color);
            border: 4px solid #fff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 100%;
            max-height: 80vh;
            outline: none;
            /* Remove focus outline */
        }

        .score-display {
            position: absolute;
            top: 100px;
            font-family: 'Fredoka', sans-serif;
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
            pointer-events: none;
        }

        .controls-hint {
            margin-top: 10px;
            font-size: 1rem;
            opacity: 0.8;
        }

        .back-btn {
            position: absolute;
            bottom: 20px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
            transition: all 0.2s;
        }

        .back-btn:hover,
        .back-btn:focus {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
            outline: 2px solid var(--accent);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .modal {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            border: 5px solid #e67e22;
            color: #2c3e50;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal h2 {
            font-family: 'Fredoka', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .modal p {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        button {
            padding: 15px 30px;
            border-radius: 15px;
            border: none;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
            background: #2ecc71;
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 0 #27ae60;
        }

        button:hover,
        button:focus {
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #27ae60;
            outline: 3px solid var(--accent);
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 #27ae60;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* TV Mode */
        body.mode-tv {
            cursor: none;
        }
    </style>
</head>

<body>

    <h1>Flappy Bird</h1>
    <div class="score-display" id="scoreDisplay">0</div>

    <canvas id="gameCanvas" width="400" height="600" tabindex="0"></canvas>

    <div class="controls-hint">Press 2, 5, Space, or Tap to Jump</div>
    <div class="controls-hint">Press 2, 5, Space, or Tap to Jump</div>
    <a href="#" class="back-btn" onclick="goHome(event)">🏠 Back to Home</a>

    <div class="modal-overlay" id="startModal">
        <div class="modal">
            <h2>Ready?</h2>
            <button onclick="startGame()">Start Game</button>
        </div>
    </div>

    <div class="modal-overlay" id="gameOverModal" style="display: none;">
        <div class="modal">
            <h2>Game Over</h2>
            <p>Score: <span id="finalScore">0</span></p>
            <button onclick="resetGame()">Play Again</button>
            <button onclick="goHome(event)"
                style="margin-top: 10px; background-color: #e74c3c; display: block; width: 100%;">Back to Home</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const startModal = document.getElementById('startModal');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreSpan = document.getElementById('finalScore');

        // Game Constants
        const GRAVITY = 0.25;
        const JUMP = -5; // Lower is higher jump (negative y)
        const PIPE_SPEED = 2;
        const PIPE_SPAWN_RATE = 120; // Frames
        const PIPE_GAP = 130;

        // Game State
        let bird = { x: 50, y: 300, width: 30, height: 30, velocity: 0 };
        let pipes = [];
        let coins = [];
        let score = 0;
        let coinsCollectedInRun = 0;
        let pillarCount = 0;
        let frameCount = 0;
        let gameState = 'start'; // start, playing, gameover
        let animationId;

        // Sound Manager
        const SoundManager = {
            ctx: null,
            init: function () {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            playTone: function (freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            jump: function () { this.playTone(400, 'square', 0.1, 0.1); },
            score: function () { this.playTone(1000, 'sine', 0.1, 0.1); },
            crash: function () {
                this.playTone(100, 'sawtooth', 0.3, 0.2);
                setTimeout(() => this.playTone(80, 'sawtooth', 0.3, 0.2), 100);
            },
            coin: function () { this.playTone(1200, 'sine', 0.1, 0.1); }
        };

        function startGame() {
            gameState = 'playing';
            startModal.style.display = 'none';
            gameOverModal.style.display = 'none';
            resetVars();
            canvas.focus();
            loop();
        }

        function resetGame() {
            startGame();
        }

        function resetVars() {
            bird = { x: 50, y: 300, width: 30, height: 30, velocity: 0 };
            pipes = [];
            coins = [];
            score = 0;
            coinsCollectedInRun = 0;
            pillarCount = 0;
            frameCount = 0;
            scoreDisplay.textContent = '0';
        }

        function jump() {
            if (gameState !== 'playing') return;
            bird.velocity = JUMP;
            SoundManager.jump();
        }

        function update() {
            // Bird Physics
            bird.velocity += GRAVITY;
            bird.y += bird.velocity;

            // Pipe Spawning
            if (frameCount % PIPE_SPAWN_RATE === 0) {
                const minHeight = 50;
                const maxHeight = canvas.height - PIPE_GAP - minHeight;
                const height = Math.floor(Math.random() * (maxHeight - minHeight + 1) + minHeight);
                pillarCount++;

                let hasCoin = false;
                // Spawn coin every 10 pillars, max 3 per run
                if (pillarCount % 10 === 0 && coinsCollectedInRun < 3) {
                    hasCoin = true;
                }

                pipes.push({
                    x: canvas.width,
                    y: 0,
                    width: 50,
                    height: height,
                    passed: false
                });

                if (hasCoin) {
                    // Randomize coin position within gap (harder to catch)
                    const minCoinY = height + 5;
                    const maxCoinY = height + PIPE_GAP - 35; // 30 height + 5 margin
                    const coinY = Math.floor(Math.random() * (maxCoinY - minCoinY + 1) + minCoinY);

                    coins.push({
                        x: canvas.width + 10, // centered horizontally (pipe width 50 - coin width 30) / 2 = 10
                        y: coinY,
                        width: 30,
                        height: 30,
                        collected: false
                    });
                }
            }

            // Pipe Movement & Collision
            for (let i = 0; i < pipes.length; i++) {
                let p = pipes[i];
                p.x -= PIPE_SPEED;

                // Collision Detection
                // Top Pipe
                if (
                    bird.x < p.x + p.width &&
                    bird.x + bird.width > p.x &&
                    bird.y < p.height
                ) {
                    gameOver();
                }
                // Bottom Pipe
                if (
                    bird.x < p.x + p.width &&
                    bird.x + bird.width > p.x &&
                    bird.y + bird.height > p.height + PIPE_GAP
                ) {
                    gameOver();
                }

                // Score
                if (p.x + p.width < bird.x && !p.passed) {
                    score++;
                    scoreDisplay.textContent = score;
                    p.passed = true;
                    SoundManager.score();
                }
            }

            // Coin Movement & Collision
            for (let i = 0; i < coins.length; i++) {
                let c = coins[i];
                c.x -= PIPE_SPEED;

                if (!c.collected &&
                    bird.x < c.x + c.width &&
                    bird.x + bird.width > c.x &&
                    bird.y < c.y + c.height &&
                    bird.y + bird.height > c.y) {

                    c.collected = true;
                    coinsCollectedInRun++;
                    SoundManager.coin();
                    if (typeof GoldManager !== 'undefined') {
                        GoldManager.addCoins(1);
                    }
                }
            }

            // Remove off-screen pipes & coins
            if (pipes.length > 0 && pipes[0].x < -50) pipes.shift();
            if (coins.length > 0 && coins[0].x < -50) coins.shift();

            // Ground/Ceiling Collision
            if (bird.y + bird.height > canvas.height || bird.y < 0) {
                gameOver();
            }

            frameCount++;
        }

        function draw() {
            // Clear
            ctx.fillStyle = '#70c5ce';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Pipes
            ctx.fillStyle = '#2ecc71';
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 3;

            pipes.forEach(p => {
                // Top Pipe
                ctx.fillRect(p.x, 0, p.width, p.height);
                ctx.strokeRect(p.x, 0, p.width, p.height);

                // Bottom Pipe
                const bottomY = p.height + PIPE_GAP;
                const bottomHeight = canvas.height - bottomY;
                ctx.fillRect(p.x, bottomY, p.width, bottomHeight);
                ctx.strokeRect(p.x, bottomY, p.width, bottomHeight);
            });

            // Draw Coins
            coins.forEach(c => {
                if (!c.collected) {
                    ctx.fillStyle = '#FFD700'; // Gold
                    ctx.beginPath();
                    ctx.arc(c.x + 15, c.y + 15, 15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#B8860B';
                    ctx.font = 'bold 20px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('$', c.x + 15, c.y + 15);
                }
            });

            // Draw Bird
            ctx.fillStyle = '#f1c40f';
            ctx.fillRect(bird.x, bird.y, bird.width, bird.height);

            // Bird Eye
            ctx.fillStyle = 'white';
            ctx.fillRect(bird.x + 20, bird.y + 5, 8, 8);
            ctx.fillStyle = 'black';
            ctx.fillRect(bird.x + 24, bird.y + 7, 2, 2);

            // Bird Wing
            ctx.fillStyle = '#f39c12';
            ctx.fillRect(bird.x + 5, bird.y + 18, 15, 8);

            // Ground Strip
            ctx.fillStyle = '#ded895';
            ctx.fillRect(0, canvas.height - 20, canvas.width, 20);
            ctx.fillStyle = '#73bf2e';
            ctx.fillRect(0, canvas.height - 20, canvas.width, 5);
        }

        function loop() {
            if (gameState === 'playing') {
                update();
                draw();
                animationId = requestAnimationFrame(loop);
            }
        }

        function gameOver() {
            gameState = 'gameover';
            SoundManager.crash();
            cancelAnimationFrame(animationId);
            finalScoreSpan.textContent = score;
            gameOverModal.style.display = 'flex';

            // Focus Play Again
            setTimeout(() => {
                const btn = gameOverModal.querySelector('button');
                if (btn) btn.focus();
            }, 100);

            // Sync Data
            if (typeof TimeManager !== 'undefined') {
                TimeManager.syncTimeRemote(true);
            }
        }

        // Input Handling
        document.addEventListener('keydown', (e) => {
            const key = e.key;
            const keyCode = e.keyCode;

            // TV Keys
            const TV_ENTER = 13;
            const ALT_ENTER = 23;
            const TV_UP = 38;
            const ALT_UP = 19;
            const ALT_BACK = 4;
            const TIZEN_BACK = 10009;

            let handled = false;

            // Handle Back Button
            if (key === 'Backspace' || key === 'Escape' || keyCode === 8 || keyCode === 27 || keyCode === 461 || keyCode === TIZEN_BACK || keyCode === ALT_BACK) {
                window.location.href = 'index.html';
                handled = true;
            }

            // Jump Keys: 2, 5, Space, Up Arrow, Enter
            if (['2', '5', ' ', 'ArrowUp', 'Enter'].includes(key) || [TV_ENTER, ALT_ENTER, TV_UP, ALT_UP].includes(keyCode)) {
                if (gameState === 'playing') {
                    jump();
                    handled = true;
                } else {
                    // Start or Game Over screens
                    const focusedBtn = document.activeElement;
                    if (focusedBtn && focusedBtn.tagName === 'BUTTON') {
                        focusedBtn.click();
                    } else {
                        // Fallback if focus is lost
                        if (gameState === 'start') startGame();
                        else if (gameState === 'gameover') resetGame();
                    }
                    handled = true;
                }
            }

            if (key === '0' || key.toLowerCase() === 'f') {
                toggleFullScreen();
                handled = true;
            }

            if (handled) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        async function goHome(event) {
            if (event) event.preventDefault();
            if (typeof TimeManager !== 'undefined') {
                await TimeManager.syncTimeRemote(true);
            }
            window.location.href = 'index.html';
        }

        // Touch/Click Handling
        canvas.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (gameState === 'playing') jump();
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'playing') jump();
        }, { passive: false });

        // Initial Draw
        draw();

        // Check mode
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            if (mode) {
                document.body.classList.add(`mode-${mode}`);
            }
        });

        // Focus Start Button or Canvas
        window.onload = () => {
            if (startModal.style.display !== 'none') {
                startModal.querySelector('button').focus();
            } else {
                canvas.focus();
            }
        };

        // Keep focus
        canvas.addEventListener('blur', () => {
            if (gameState === 'playing') {
                setTimeout(() => canvas.focus(), 50);
            }
        });

    </script>
    <script src="global.js?v=11"></script>
</body>

</html>